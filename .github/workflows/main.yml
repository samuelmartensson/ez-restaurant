on: push
name: ðŸš€ Deploy website on push
jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy
    runs-on: ubuntu-latest
    steps:
      - name: ðŸšš Get latest code
        uses: actions/checkout@v3

      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: "8.0.x"
      - run: dotnet publish -c Release -o publish
        working-directory: backend

      - name: Add SSH Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan 172.232.147.147 >> ~/.ssh/known_hosts

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}
      - name: Change ownership of .aspnet directory
        run: |
          sudo chown -R wilhelm:wilhelm .aspnet/

      - name: Install rsync and Verify Installation
        run: |
          sudo apt-get -y install rsync openssh-client

      - name: Deploy Dotnet App
        run: /usr/bin/rsync -rlDvz --delete ./backend/publish/ wilhelm@172.232.147.147:/var/www/restaurantbackend/

      - name: Restart service on CentOS server
        env:
          SUDO_PASSWORD: ${{ secrets.SU_PW }}
        run: |
          ssh -o StrictHostKeyChecking=no wilhelm@172.232.147.147 "
            echo $SUDO_PASSWORD | sudo -S systemctl restart restaurantbackend.service
           "
